version: 1.0
description: This gets the nunber of executions of a action on a host.

input:
  - host
  - action
  - date
tasks:
  getNumberOfExecutions:
    action: sql.query
    input:
      connection: mysql
      query: select count(*) FROM executions WHERE action = '<% ctx(action) %>' AND hostname = '<% ctx(host) %>' AND executiontime BETWEEN <% ctx(date) %> and NOW()
    next:
      - when: <% succeeded() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
          - numberOfExecutions: <% result().stdout %>
      - when: <% failed() %>
        publish:
          - stdout: <% result().stdout %>
          - stderr: <% result().stderr %>
          - failure: |
            *MaGiCARP ran into a MYSQL error*
            Notification recieved concerning <% ctx(host) %> 
            
            *Error*
            ``` <% ctx(result().stdout) %>```
            ``` <% ctx(result().stderr) %>```
        do: 
         - failed
         - fail
  failed:
    action: slack.post_message
    input:
      message: <% ctx(failure) %>
output:
  - numberOfExecutions: <% ctx(numberOfExecutions) %>
  - stdout: <% ctx(stdout) %>
  - stderr: <% ctx(stderr) %>